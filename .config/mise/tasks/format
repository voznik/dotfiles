#!/usr/bin/env lua
--MISE description="Format a file or folder based on extension"
--MISE usage='arg "<path>" help="File or folder to format"'
--MISE dir="{{cwd}}"

package.path = package.path .. ";" .. os.getenv("XDG_CONFIG_DIR") .. "/lua/?.lua"
local formatter = require("formatter")

local path = os.getenv("usage_path") or arg[1]
if not path then
    print("Usage: mise format <path>")
    os.exit(1)
end

-- Make path absolute if relative
if not path:match("^/") then
    path = (os.getenv("PWD") or ".") .. "/" .. path
end

-- Check if path contains wildcards
if path:match("[*?]") then
    local handle = io.popen("ls -1d " .. path .. " 2>/dev/null")
    local files = handle:read("*a")
    handle:close()

    for file in files:gmatch("[^\n]+") do
        local ext = file:match("%.([^%.]+)$")
        if ext and formatter.formatters[ext] then
            -- Make file path absolute
            local abs_file = file
            if not file:match("^/") then
                abs_file = (os.getenv("PWD") or ".") .. "/" .. file
            end
            formatter.format(abs_file)
        end
    end
    os.exit(0)
end

-- Check if it's a directory
local function is_dir(p)
    local result = os.execute("test -d '" .. p .. "'")
    return result == true or result == 0
end

if is_dir(path) then
    -- Format all supported files in directory
    local handle = io.popen("find '" .. path .. "' -maxdepth 1 -type f")
    local files = handle:read("*a")
    handle:close()

    for file in files:gmatch("[^\n]+") do
        local ext = file:match("%.([^%.]+)$")
        if ext and formatter.formatters[ext] then
            formatter.format(file)
        end
    end
else
    -- Format single file
    local success, err = formatter.format(path)
    if not success then
        print("Error: " .. (err or "Format failed"))
        os.exit(1)
    end
end
